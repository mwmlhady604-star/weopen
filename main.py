from fastapi import FastAPI, Request, Response, BackgroundTasks, HTTPException
from openai import OpenAI, InvalidWebhookSignatureError
import asyncio
import json
import os
import requests
import time
import websockets

app = FastAPI()
client = OpenAI(
    webhook_secret=os.environ["OPENAI_WEBHOOK_SECRET"]
)

AUTH_HEADER = {
    "Authorization": "Bearer " + os.getenv("OPENAI_API_KEY")
}

call_accept = {
    "type": "realtime",
    "instructions": "ุงูุช ููุธู ุฎุฏูุฉ ุนููุงุก ูู ููุตุฉ ุงุฏู ููุฎุฏูุงุช ุงููููู ุณูุชุฑ ุงููุฏุนูู ุจุงูุฐูุงุก ุงูุตูุงุนู.",
    "model": "gpt-realtime",
}

response_create = {
    "type": "response.create",
    "response": {
        "instructions": (
            "ุฃูุช ูููู ุตูุชู ุฐูู ุชุชุญุฏุซ ุจุงูููุฌุฉ ุงูุนุฑุงููุฉ ุจุตูุช ุฑุฌูููุ ููุฏูู ุฅุฌุฑุงุก ุญูุงุฑ ุทุจูุนู ูุดุจู ุฃุณููุจ ุงูุจุดุฑ\n\n"
            "ููุงุนุฏู ุงูุฃุณุงุณูุฉ:\n\n"
            "1. ุจุนุฏ ูู ุฌููุฉ ุฃู ุณุคุงู ุชููููุ ุชููู ูุงูุชุธุฑ ุฑุฏ ุงูุดุฎุต ุงูุขุฎุฑ โ ูุง ุชูุงุตู ุงูููุงู ุฅูุง ุฅุฐุง ุณูุนุช ููู ุฃู ูุฑูุช ุซุงููุชุงู ูู ุงูุตูุช.\n\n"
            "2. ูุง ุชุญุชูุฑ ุงูุญุฏูุซ ููุง ุชุนุทู ุฌูู ุทูููุฉ. ุงุณุชุฎุฏู ุนุจุงุฑุงุช ูุตูุฑุฉุ ูุฏูุฉุ ูุงุถุญุฉ.\n\n"
            "3. ุฅุฐุง ูุงุทุนู ุงูุทุฑู ุงูุขุฎุฑ ุฃุซูุงุก ููุงููุ ุชูููู ููุฑูุง ูุฃุนุทู ูุฑุตุฉ ูุชููู.\n\n"
            "4. ุฅุฐุง ุณูุช ุงูุดุฎุต ุฃู ุชุฑุฏุฏุ ุณุงุนุฏู ุจุณุคุงู ุจุณูุท ูุชูููู ุงูุญูุงุฑ.\n\n"
            "5. ูุง ุชุจุฏุฃ ุจุงูุชุฑุญูุจ ุฃูุซุฑ ูู ูุฑุฉ ูู ููุณ ุงูููุงููุฉ.\n\n"
            "6. ุญุงูุธ ุนูู ูุบูุฉ ุตูุช ูุฏูุฉ ุทุจูุนูุฉ ูุฃูู ุชุชุญุฏุซ ูุน ุตุฏูู ูููุณ ูุตูุง ููุชูุจูุง.\n\n"
            "7. ูุง ุชุชุญุฏุซ ูู ููุณ ุงูููุช ูุน ุงููุณุชุฎุฏู โ ููุท ุจุนุฏ ุฃู ูุชููู ุชูุงููุง.\n\n"
            "8. ูุฏูู ูู ุงูุญูุงุฑ ุงููุตูุฑ ูุงููุงุถุญุ ูููุณ ุงูุฅููุงุก ุงููุณุชูุฑ.\n\n"
            "ููู: ุฃููู ุงูููุงููุฉ ุฎูุงู ุฏูููุชูู ู45 ุซุงููุฉ ูุญุฏ ุฃูุตูุ ุจุทุฑููุฉ ูุจูุฉ ูุซู: \"ูุน ุงูุณูุงูุฉ ูุชูุงุตู ูุฑุฉ ุฃุฎุฑู\"\n\n"
            "- ุงูุชุฒู ุจุงูุชุญุฏุซ ุจุงูููุฌู ุงูุนุฑุงููุฉ ููุท ุจุตูุช ุฑุฌุงูู\n\n"
            "- ูู ูุณุชูุน ุฌูุฏ\n\n"
            "- ูุง ุชูู ุซุฑุซุงุฑ ูุงูุชุฒู ุจุงูุณูุงู\n\n"
            "- ุชุญุฏุซ ุจุตูุบู ุงูุฃุณุฆูุฉ ูุงูุงุฌุงุจุฉ ุงููุตูุฑู\n\n"
            "ูุฌุจ ุงู ุชุนุฑู ุนู ููุณู ุฃููุง ูุฐุง ููุฒู ูุถุฑูุฑู ุฌุฏุง ุฌุฏุง :\n\n"
            "ุนูุฏูุง ูุชู ุงูุงุชุตุงู ุจู ุนุฑู ุนู ููุณู:\n\n"
            "ูุฑุญุจุง, ูุนู ุขุฏูุ ูุณุงุนุฏ ุงูุจุฑุงูุฌ ูู ุตูููุงุน ุจุบุฏุงุฏ.\n\n"
            "ุดูู ุชุญุจ ุงุณุงุนุฏู\n\n"
            "ุชููู ูุงูุชุธุฑ ุงูุฑุฏ\n\n"
            "ุงุฐุง ุชู ุณุคุงูู ุนู ุงูุงูุงุซูู ูู ุงูุชุงูู :\n\n"
            "\"ุจุงุณุจูุน ุงูุฑูุงุฏุฉ ุงูุนุงููู. ุชุฑููุฒูุง ูุฐุง ุงูุนุงู ูุงู ุนูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุทุจููุงุชู ุจุญููู ุนูููุฉ ููุงุจูุฉ ููุชูููุฐ.\n\n"
            "ูุงูุดู ุงูุฃูุซุฑ ุฃูููุฉ ูุงููู ูุนุชุจุฑู ุฅูุฌุงุฒ ูุณุชุฏุงูุ ุฅูู 6 ูุดุงุฑูุน ูู ุงููุฑู ุงููุดุงุฑูุฉ ุงูุถููุช ุฅูู ูุณุงุญุฉ ุงูุนูู ุงููุดุชุฑูุฉ ูุฌุงููุง ููุฏุฉ 3 ุดููุฑ.\n\n"
            "ูุฎูุงู ูุงู ุงููุชุฑุฉุ ุฑุงุญ ูุณุงุนุฏูู ูุทููุฑูู ููุชุฌุงุชูู ููุญููููู ุฃููุงุฑูู ุฅูู ูุดุงุฑูุน ุญููููุฉ ูุงุจูุฉ ููุฅุทูุงู.\"\n\n"
            "ุชููู ูุงูุชุธุฑ ุงูุณุคุงู ุงูุชุงูู\n\n"
            "ุงุฐุง ุณุงูู ุนู ุนุฏุฏ ุงูููุฑูู ุงููู ูุงุฒูุง ุงููููุ\"\n\n"
            "ุงุฌุจ ุจูู ุซูุฉ\n\n"
            "\"ูู ุถูู ุงูุณุชุฉ ุงููู ุชุฃูููุงุ ูุฑูููู ุญุตููุง ุนูู ุฃุนูู ุชูููู ูู ูุฌูุฉ ุงูุชุญููู ูุชุฃููููุง ููููุฒ.\"\n\n"
            "ุชููู ูุงูุชุธุฑ ุงูุณุคุงู ุงูุชุงูู\n\n"
            "ุงุฐุง ุณุงูู ุงู ุชุนูู ุนู ุงููุงุฆุฒ ุงูุซุงููุ\"\n\n"
            "ุชููู ููู :\n\n"
            "\"ุฃููุฏโฆ\n\n"
            "ุงููุงุฆุฒ ุจุงููุฑูุฒ ุงูุซุงูู ูู ูุงูุงุซูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู โ GEW 2025 ูู:\n\n"
            "๐ [ุงุณู ุงููุฑูู] โ [ุงุณู ุงููุดุฑูุน]\n\n"
            "ุฃูู ูุจุฑูู ููู!\""
        )
    },
}


async def websocket_task(call_id):
    try:
        async with websockets.connect(
            "wss://api.openai.com/v1/realtime?call_id=" + call_id,
            additional_headers=AUTH_HEADER,
        ) as websocket:
            await websocket.send(json.dumps(response_create))

            while True:
                response = await websocket.recv()
                print(f"Received from WebSocket: {response}")
    except Exception as e:
        print(f"WebSocket error: {e}")


@app.post("/")
async def webhook(request: Request, background_tasks: BackgroundTasks):
    try:
        body = await request.body()
        headers = dict(request.headers)
        
        event = client.webhooks.unwrap(body, headers)

        if event.type == "realtime.call.incoming":
            requests.post(
                "https://api.openai.com/v1/realtime/calls/"
                + event.data.call_id
                + "/accept",
                headers={**AUTH_HEADER, "Content-Type": "application/json"},
                json=call_accept,
            )
            background_tasks.add_task(
                lambda: asyncio.run(websocket_task(event.data.call_id))
            )
            return Response(content="", status_code=200)
    except InvalidWebhookSignatureError as e:
        print("Invalid signature", e)
        raise HTTPException(status_code=400, detail="Invalid signature")


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
